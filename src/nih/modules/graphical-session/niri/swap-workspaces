#!/usr/bin/env python
import json
import subprocess


def _focus_workspace(name):
    subprocess.run(["niri", "msg", "action", "focus-workspace", name])


def _move_workspace(workspace_name, output_name):
    subprocess.run(["niri", "msg", "action", "move-workspace-to-monitor", "--reference", workspace_name, output_name])


def main():
    workspaces = json.loads(subprocess.check_output(["niri", "msg", "-j", "workspaces"]))
    active_mapping = {}
    current_focused = {}
    for workspace in workspaces:
        workspace_name = workspace["name"]
        if workspace_name is None:
            continue
        if workspace["is_active"]:
            active_mapping[workspace["output"]] = workspace_name
        if workspace["is_focused"]:
            current_focused[workspace_name] = workspace["is_focused"]
        elif workspace["is_active"]:
            current_focused[workspace_name] = False
    reversed_mapping = dict(zip(reversed(active_mapping.keys()), active_mapping.values(), strict=True))
    new_focused = {k: not v for k, v in current_focused.items()}
    for output_name, workspace_name in reversed_mapping.items():
        _move_workspace(workspace_name, output_name)
        _focus_workspace(workspace_name)
    for workspace_name, requires_focus in new_focused.items():
        if requires_focus:
            _focus_workspace(workspace_name)


if __name__ == '__main__':
    main()
